<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç My Trips</title>
  <link rel="stylesheet" href="trip.css"> 
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1> My Travel Journal</h1>
      <div class="header-actions">
        <a href="dashboard.html" class="dashboard-btn">‚Üê Dashboard</a>
        <a href="creat_trip.html" class="create-btn">+ New Trip</a>
      </div>
    </header>
    
    <div class="controls">
      <div class="filters">
        <select id="statusFilter" class="filter-select">
          <option value="all">All Trips</option>
          <option value="wishlist">Wishlist</option>
          <option value="upcoming">Upcoming</option>
          <option value="completed">Completed</option>
        </select>
        <div class="search-box">
          <input type="text" id="searchBox" placeholder="Search trips...">
        </div>
      </div>
    </div>
    
    <div class="trip-cards" id="tripsContainer">
      <div class="loading-spinner"></div>
    </div>
  </div>

<script>
  // Helper functions
  function showLoading() {
    document.getElementById('tripsContainer').innerHTML = `
      <div class="loading-spinner"></div>
      <p>Loading your trips...</p>
    `;
  }

  function showError(message) {
    document.getElementById('tripsContainer').innerHTML = `
      <div class="error-message">
        <p>${message}</p>
        <button onclick="loadTrips()">Retry</button>
      </div>
    `;
  }

  function parseDateSafe(dateString) {
    // Handle cases where date might be already formatted or invalid
    if (!dateString) return null;
    
    // Try ISO format first
    let date = new Date(dateString);
    if (!isNaN(date.getTime())) return date;
    
    // Try removing timezone if present (common issue)
    date = new Date(dateString.split('T')[0]);
    if (!isNaN(date.getTime())) return date;
    
    // Try parsing as timestamp
    date = new Date(parseInt(dateString));
    if (!isNaN(date.getTime())) return date;
    
    return null;
  }

  function formatDateForDisplay(dateString) {
    const date = parseDateSafe(dateString);
    if (!date) return 'Date not available';
    
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  async function loadTrips() {
    showLoading();
    
    try {
      // 1. Get user from localStorage
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.id) {
        window.location.href = 'login.html';
        return;
      }

      // 2. Fetch trips from backend
      const response = await fetch(`http://localhost:3000/api/trips?userId=${encodeURIComponent(user.id)}`);
      
      // 3. Handle response
      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || `Server error: ${response.status}`);
      }

      const trips = await response.json();
      displayTrips(trips);
      
    } catch (error) {
      console.error('Error loading trips:', error);
      showError(error.message || 'Failed to load trips. Please try again.');
    }
  }

  function displayTrips(trips) {
    const container = document.getElementById('tripsContainer');
    if (!container) return;
    
    container.innerHTML = '';

    if (!trips || !Array.isArray(trips) || trips.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p>No trips found. Create your first trip!</p>
          <a href="creat_trip.html" class="btn">Create Trip</a>
        </div>
      `;
      return;
    }

    trips.forEach(trip => {
      const card = document.createElement('div');
      card.className = `trip-card ${trip.status || ''}`;
      card.innerHTML = `
        <div class="card-header">
          <div class="trip-title">
            <h2>${trip.title || 'Untitled Trip'}</h2>
            <div class="destination">${trip.destination || 'No destination'}</div>
          </div>
          <div class="status-bubble ${trip.status || ''}">${trip.status || 'unknown'}</div>
        </div>
        <div class="card-dates">
          <span>${formatDateForDisplay(trip.startDate)}</span>
          <span>to</span>
          <span>${formatDateForDisplay(trip.endDate)}</span>
        </div>
        <div class="card-actions">
          <button class="btn-view" onclick="viewTrip('${trip._id}')">View Details</button>
          <button class="btn-edit" onclick="editTrip('${trip._id}')">Edit</button>
          <button class="btn-delete" onclick="deleteTrip('${trip._id}')">‚úï</button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', function() {
    loadTrips();
    // Auto-open from dashboard
    const viewTripId = localStorage.getItem('viewTripId');
    const editTripId = localStorage.getItem('editTripId');
    if (viewTripId) {
      localStorage.removeItem('viewTripId');
      setTimeout(() => viewTrip(viewTripId), 400);
    }
    if (editTripId) {
      localStorage.removeItem('editTripId');
      setTimeout(() => editTrip(editTripId), 400);
    }
  });

  // View trip details
  async function viewTrip(tripId) {
    try {
      const response = await fetch(`http://localhost:3000/api/trips/${tripId}`);
      if (!response.ok) throw new Error('Failed to fetch trip details');
      const trip = await response.json();
      showTripModal(trip, 'view');
    } catch (error) {
      console.error('Error viewing trip:', error);
      alert('Failed to load trip details');
    }
  }

  // Edit trip
  async function editTrip(tripId) {
    try {
      const response = await fetch(`http://localhost:3000/api/trips/${tripId}`);
      if (!response.ok) throw new Error('Failed to fetch trip details');
      const trip = await response.json();
      showTripModal(trip, 'edit');
    } catch (error) {
      console.error('Error editing trip:', error);
      alert('Failed to load trip details');
    }
  }

  // Delete trip
  async function deleteTrip(tripId) {
    if (!confirm('Are you sure you want to delete this trip?')) return;
    try {
      const response = await fetch(`http://localhost:3000/api/trips/${tripId}`, { method: 'DELETE' });
      if (!response.ok) throw new Error('Failed to delete trip');
      alert('Trip deleted successfully!');
      loadTrips();
    } catch (error) {
      console.error('Error deleting trip:', error);
      alert('Failed to delete trip');
    }
  }

  // Modal
  function showTripModal(trip, mode) {
    const modal = document.createElement('div');
    modal.className = 'trip-modal';
    modal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2>${mode === 'view' ? 'Trip Details' : 'Edit Trip'}</h2>
          <button class="close-btn" onclick="closeModal()">√ó</button>
        </div>
        <div class="modal-body">
          ${mode === 'view' ? generateViewContent(trip) : generateEditForm(trip, trip._id)}
        </div>
      </div>
    `;
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
  }

  function generateViewContent(trip) {
    const startDate = formatDateForDisplay(trip.startDate);
    const endDate = formatDateForDisplay(trip.endDate);
    const budgetSpent = trip.budget?.spent || 0;
    const budgetTotal = trip.budget?.total || 0;
    const budgetPercentage = budgetTotal > 0 ? Math.round((budgetSpent / budgetTotal) * 100) : 0;
    return `
      <div class="trip-details">
        <div class="detail-row"><strong>Title:</strong> ${trip.title}</div>
        <div class="detail-row"><strong>Destination:</strong> ${trip.destination}</div>
        <div class="detail-row"><strong>Dates:</strong> ${startDate} to ${endDate}</div>
        <div class="detail-row"><strong>Status:</strong> <span class="status-bubble ${trip.status}">${trip.status}</span></div>
        <div class="detail-row"><strong>Budget:</strong> $${budgetSpent} / $${budgetTotal} (${budgetPercentage}%)</div>
        ${trip.notes ? `<div class="detail-row"><strong>Notes:</strong> ${trip.notes}</div>` : ''}
        ${trip.packingList && trip.packingList.length > 0 ? `
          <div class="packing-section">
            <h3>Packing List</h3>
            <div class="packing-items">
              ${trip.packingList.map(item => `
                <div class="packing-item ${item.packed ? 'packed' : ''}">
                  <span class="item-name">${item.item}</span>
                  <span class="packed-status">${item.packed ? '‚úì Packed' : '‚óã Not packed'}</span>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    `;
  }

  function generateEditForm(trip, tripId) {
    const startDate = trip.startDate ? new Date(trip.startDate).toISOString().split('T')[0] : '';
    const endDate = trip.endDate ? new Date(trip.endDate).toISOString().split('T')[0] : '';
    return `
      <form id="editTripForm" data-trip-id="${tripId}">
        <input type="text" id="editTitle" value="${trip.title}" placeholder="Trip Title" required>
        <input type="text" id="editDestination" value="${trip.destination}" placeholder="Destination" required>
        <div class="date-fields">
          <input type="date" id="editStartDate" value="${startDate}" required>
          <input type="date" id="editEndDate" value="${endDate}" required>
        </div>
        <div class="status-options">
          <label class="status-option">Wishlist
            <input type="radio" name="editStatus" value="wishlist" ${trip.status === 'wishlist' ? 'checked' : ''}>
          </label>
          <label class="status-option">Upcoming
            <input type="radio" name="editStatus" value="upcoming" ${trip.status === 'upcoming' ? 'checked' : ''}>
          </label>
          <label class="status-option">Completed
            <input type="radio" name="editStatus" value="completed" ${trip.status === 'completed' ? 'checked' : ''}>
          </label>
        </div>
        <div class="budget-fields">
          <input type="number" id="editTotalBudget" value="${trip.budget?.total || 0}" placeholder="Total Budget ($)">
          <input type="number" id="editSpentBudget" value="${trip.budget?.spent || 0}" placeholder="Amount Spent ($)">
        </div>
        <textarea id="editNotes" placeholder="Additional notes...">${trip.notes || ''}</textarea>
        <div class="form-actions">
          <button type="submit">Update Trip</button>
          <button type="button" onclick="closeModal()">Cancel</button>
        </div>
      </form>
    `;
  }

  function closeModal() {
    const modal = document.querySelector('.trip-modal');
    if (modal) {
      modal.remove();
      document.body.style.overflow = 'auto';
    }
  }

  // Handle edit submit
  document.addEventListener('submit', async (e) => {
    if (e.target.id === 'editTripForm') {
      e.preventDefault();
      const tripId = e.target.dataset.tripId;
      const formData = {
        title: document.getElementById('editTitle').value.trim(),
        destination: document.getElementById('editDestination').value.trim(),
        startDate: document.getElementById('editStartDate').value,
        endDate: document.getElementById('editEndDate').value,
        status: document.querySelector('input[name="editStatus"]:checked').value,
        budget: {
          total: parseFloat(document.getElementById('editTotalBudget').value) || 0,
          spent: parseFloat(document.getElementById('editSpentBudget').value) || 0
        },
        notes: document.getElementById('editNotes').value.trim()
      };
      try {
        const response = await fetch(`http://localhost:3000/api/trips/${tripId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });
        if (!response.ok) throw new Error('Failed to update trip');
        alert('Trip updated successfully!');
        closeModal();
        loadTrips();
      } catch (error) {
        console.error('Error updating trip:', error);
        alert('Failed to update trip');
      }
    }
  });
</script>
</body>
</html>