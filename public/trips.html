<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üåç My Trips</title>
  <link rel="stylesheet" href="trip.css"> 
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1> My Travel Journal</h1>
      <a href="creat_trip.html" class="create-btn">+ New Trip</a>
    </header>
    
    <div class="controls">
      <div class="filters">
        <select id="statusFilter" class="filter-select">
          <option value="all">All Trips</option>
          <option value="wishlist">Wishlist</option>
          <option value="upcoming">Upcoming</option>
          <option value="completed">Completed</option>
        </select>
        <div class="search-box">
          <input type="text" id="searchBox" placeholder="Search trips...">
        </div>
      </div>
    </div>
    
    <div class="trip-cards" id="tripsContainer">
      <div class="loading-spinner"></div>
    </div>
  </div>

<script>
  // Helper functions
  function showLoading() {
    document.getElementById('tripsContainer').innerHTML = `
      <div class="loading-spinner"></div>
      <p>Loading your trips...</p>
    `;
  }

  function showError(message) {
    document.getElementById('tripsContainer').innerHTML = `
      <div class="error-message">
        <p>${message}</p>
        <button onclick="loadTrips()">Retry</button>
      </div>
    `;
  }

  function parseDateSafe(dateString) {
    // Handle cases where date might be already formatted or invalid
    if (!dateString) return null;
    
    // Try ISO format first
    let date = new Date(dateString);
    if (!isNaN(date.getTime())) return date;
    
    // Try removing timezone if present (common issue)
    date = new Date(dateString.split('T')[0]);
    if (!isNaN(date.getTime())) return date;
    
    // Try parsing as timestamp
    date = new Date(parseInt(dateString));
    if (!isNaN(date.getTime())) return date;
    
    return null;
  }

  function formatDateForDisplay(dateString) {
    const date = parseDateSafe(dateString);
    if (!date) return 'Date not available';
    
    return date.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  }

  async function loadTrips() {
    showLoading();
    
    try {
      // 1. Get user from localStorage
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!user.id) {
        window.location.href = 'login.html';
        return;
      }

      // 2. Fetch trips from backend
      const response = await fetch(`http://localhost:3000/api/trips?userId=${encodeURIComponent(user.id)}`);
      
      // 3. Handle response
      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(error.message || `Server error: ${response.status}`);
      }

      const trips = await response.json();
      displayTrips(trips);
      
    } catch (error) {
      console.error('Error loading trips:', error);
      showError(error.message || 'Failed to load trips. Please try again.');
    }
  }

  function displayTrips(trips) {
    const container = document.getElementById('tripsContainer');
    if (!container) return;
    
    container.innerHTML = '';

    if (!trips || !Array.isArray(trips) || trips.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <p>No trips found. Create your first trip!</p>
          <a href="creat_trip.html" class="btn">Create Trip</a>
        </div>
      `;
      return;
    }

    trips.forEach(trip => {
      const card = document.createElement('div');
      card.className = `trip-card ${trip.status || ''}`;
      card.innerHTML = `
        <div class="card-header">
          <div class="trip-title">
            <h2>${trip.title || 'Untitled Trip'}</h2>
            <div class="destination">${trip.destination || 'No destination'}</div>
          </div>
          <div class="status-bubble ${trip.status || ''}">${trip.status || 'unknown'}</div>
        </div>
        <div class="card-dates">
          <span>${formatDateForDisplay(trip.startDate)}</span>
          <span>to</span>
          <span>${formatDateForDisplay(trip.endDate)}</span>
        </div>
        <div class="card-actions">
          <button class="btn-view">View Details</button>
          <button class="btn-delete">‚úï</button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  // Initialize when page loads
  document.addEventListener('DOMContentLoaded', loadTrips);
</script>
</body>
</html>