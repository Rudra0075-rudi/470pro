
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> Create New Trip - Travel Journal</title>
    <link rel="stylesheet" href="/signup.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-plus-circle"></i> Plan New Trip</h1>
        <form id="tripForm">
            <div class="input-group">
                <i class="fas fa-map-marker-alt"></i>
                <input type="text" id="title" placeholder="Trip Title (e.g., Japan Adventure)" required>
            </div>
            <div class="input-group">
                <i class="fas fa-globe"></i>
                <input type="text" id="destination" placeholder="Destination" required>
            </div>
            
            <div class="date-fields">
                <div class="input-group">
                    <i class="fas fa-calendar-alt"></i>
                    <input type="date" id="startDate" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-calendar-check"></i>
                    <input type="date" id="endDate" required>
                </div>
            </div>
            
            <div class="status-options">
                <label class="status-option">
                    <input type="radio" name="status" value="wishlist" checked>
                    <i class="fas fa-heart"></i> Wishlist
                </label>
                <label class="status-option">
                    <input type="radio" name="status" value="upcoming">
                    <i class="fas fa-plane"></i> Upcoming
                </label>
                <label class="status-option">
                    <input type="radio" name="status" value="completed">
                    <i class="fas fa-check-circle"></i> Completed
                </label>
            </div>
            
            <div class="budget-fields">
                <div class="input-group">
                    <i class="fa-solid fa-bangladeshi-taka-sign"></i>
                    <input type="number" id="totalBudget" placeholder="Total Budget (tk)">
                </div>
                <div class="input-group">
                    <i class="fas fa-credit-card"></i>
                    <input type="number" id="spentBudget" placeholder="Amount Spent (tk)">
                </div>
            </div>
            
            <div class="packing-list">
                <h3><i class="fas fa-suitcase"></i> Packing List <span id="packingCount">(1 item)</span></h3>
                <div id="packingItemsContainer">
                    <div class="packing-item">
                        <input type="text" class="packing-item-input" placeholder="Item name">
                        <div class="packed-checkbox">
                            <input type="checkbox" id="packed1">
                            <label for="packed1">Packed</label>
                        </div>
                        <button type="button" class="remove-item-btn" onclick="removePackingItem(this)" title="Remove item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <button type="button" class="add-item-btn" id="addPackingItem">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
            
            <div class="input-group">
                <i class="fas fa-sticky-note"></i>
                <textarea id="notes" placeholder="Additional notes about your trip..."></textarea>
            </div>
            
            <button type="submit" id="tripBtn">
                <span class="btn-text">Create Trip</span>
                <span class="btn-loading" style="display: none;">Creating Trip...</span>
            </button>
        </form>
    </div>

    <script>
        // Function to update packing count
        function updatePackingCount() {
            const container = document.getElementById('packingItemsContainer');
            const items = container.querySelectorAll('.packing-item');
            const countElement = document.getElementById('packingCount');
            const count = items.length;
            
            if (count === 1) {
                countElement.textContent = '(1 item)';
            } else {
                countElement.textContent = `(${count} items)`;
            }
        }

        document.getElementById('addPackingItem').addEventListener('click', () => {
            const container = document.getElementById('packingItemsContainer');
            const newItem = document.createElement('div');
            newItem.className = 'packing-item';
            const itemId = 'packed' + Date.now();
            newItem.innerHTML = `
                <input type="text" class="packing-item-input" placeholder="Item name">
                <div class="packed-checkbox">
                    <input type="checkbox" id="${itemId}">
                    <label for="${itemId}">Packed</label>
                </div>
                <button type="button" class="remove-item-btn" onclick="removePackingItem(this)" title="Remove item">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newItem);
            updatePackingCount();
        });

        // Function to remove packing item with validation
        function removePackingItem(button) {
            const container = document.getElementById('packingItemsContainer');
            const items = container.querySelectorAll('.packing-item');
            
            // Don't remove if it's the last item
            if (items.length > 1) {
                // Add visual feedback before removing
                const item = button.parentElement;
                item.style.opacity = '0.5';
                item.style.transform = 'scale(0.95)';
                
                setTimeout(() => {
                    item.remove();
                    updatePackingCount();
                }, 150);
            } else {
                // If it's the last item, just clear the input instead of removing
                const input = button.parentElement.querySelector('.packing-item-input');
                const checkbox = button.parentElement.querySelector('.packed-checkbox input[type="checkbox"]');
                input.value = '';
                checkbox.checked = false;
                
                // Add visual feedback
                const item = button.parentElement;
                item.style.background = '#e8f5e8';
                setTimeout(() => {
                    item.style.background = '';
                }, 500);
            }
        }

        document.getElementById('tripForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const btn = document.getElementById('tripBtn');
            const btnText = btn.querySelector('.btn-text');
            const btnLoading = btn.querySelector('.btn-loading');
            
            // Get user from localStorage
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user || !user.id) {
                alert('Please login first');
                window.location.href = 'login.html';
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.classList.add('loading');
            btnText.style.display = 'none';
            btnLoading.style.display = 'inline';

            try {
                // Prepare trip data
                const tripData = {
                    title: document.getElementById('title').value.trim(),
                    destination: document.getElementById('destination').value.trim(),
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    status: document.querySelector('input[name="status"]:checked').value,
                    packingList: getPackingItems(),
                    budget: {
                        total: parseFloat(document.getElementById('totalBudget').value) || 0,
                        spent: parseFloat(document.getElementById('spentBudget').value) || 0
                    },
                    notes: document.getElementById('notes').value.trim(),
                    userId: user.id
                };

                // Validate required fields
                if (!tripData.title || !tripData.destination || !tripData.startDate || !tripData.endDate) {
                    throw new Error('Please fill all required fields');
                }

                // Make API request
                const response = await fetch('http://localhost:3000/api/trips', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(tripData),
                    mode: 'cors'
                });

                // Handle response
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || `Server responded with status ${response.status}`);
                }

                const result = await response.json();
                console.log('Trip created:', result);
                
                // Show success state
                btn.style.background = 'var(--success)';
                btnLoading.textContent = 'Trip Created!';
                
                setTimeout(() => {
                    alert('Trip saved successfully!');
                    window.location.href = 'trips.html';
                }, 1000);

            } catch (error) {
                console.error('Trip creation error:', error);
                
                // Show error state
                btn.style.background = 'var(--danger)';
                btnLoading.textContent = 'Creation Failed';
                
                setTimeout(() => {
                    alert(`Failed to save trip: ${error.message}`);
                    
                    // Reset button
                    btn.disabled = false;
                    btn.classList.remove('loading');
                    btn.style.background = '';
                    btnText.style.display = 'inline';
                    btnLoading.style.display = 'none';
                }, 1000);
            }
        });

        // Helper function to get packing items
        function getPackingItems() {
            const items = [];
            document.querySelectorAll('.packing-item').forEach(item => {
                const input = item.querySelector('.packing-item-input');
                const checkbox = item.querySelector('.packed-checkbox input[type="checkbox"]');
                if (input.value.trim()) {
                    items.push({
                        item: input.value.trim(),
                        packed: checkbox.checked
                    });
                }
            });
            return items;
        }
    </script>
</body>
</html>
